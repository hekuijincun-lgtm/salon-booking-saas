<!-- /ui/admin.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leads 管理</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; }
    body { background:#fafafa; margin:0; }
    .wrap { max-width: 1000px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.03); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button, input, select { font: inherit; }
    button { padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#111; color:#fff; cursor:pointer; }
    button.ghost { background:#fff; color:#111; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; }
    th { background:#fafafa; }
    .muted { color:#999; font-size:12px; }
    .right { margin-left:auto; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    .toast { position:fixed; right:16px; bottom:16px; background:#111; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transform:translateY(8px); transition:all .2s; }
    .toast.show { opacity:1; transform:translateY(0); }
    dialog { border:none; border-radius:12px; padding:20px; }
    dialog::backdrop { background:rgba(0,0,0,.2); }
    input[type="password"] { width: 320px; padding:8px 10px; border-radius:10px; border:1px solid #ccc;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Leads 管理 <span id="tenant" class="pill">tenant: salon-booking-saas</span></h1>

    <div class="card">
      <div class="row">
        <button id="btn-refresh">再読み込み</button>
        <button id="btn-del" class="ghost">選択を削除</button>
        <button id="btn-export" class="right">CSVエクスポート</button>
        <button id="btn-logout" class="ghost">ログアウト</button>
      </div>
      <table id="grid">
        <thead>
          <tr>
            <th style="width:36px"><input type="checkbox" id="check-all"></th>
            <th>名前</th><th>メール</th><th>チャネル</th><th>メモ</th><th>作成</th><th>ID</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty" class="muted" style="display:none;margin-top:8px;">データはまだありません。</div>
    </div>
  </div>

  <dialog id="dlg-login">
    <form method="dialog">
      <h3>管理ログイン</h3>
      <p class="muted">ADMIN_KEY を入力してください。</p>
      <p><input id="admin-key" type="password" placeholder="ADMIN_KEY" autocomplete="current-password" /></p>
      <div class="row">
        <button id="do-login">ログイン</button>
        <button value="cancel" class="ghost">キャンセル</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast">done</div>

  <script>
    const BASE = location.origin;
    const TENANT = "salon-booking-saas";
    const grid = document.querySelector("#grid tbody");
    const toast = document.querySelector("#toast");
    const dlg = document.querySelector("#dlg-login");
    const $ = (s)=>document.querySelector(s);

    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1800); }

    async function api(action, body) {
      const r = await fetch(`/api?action=${encodeURIComponent(action)}`, {
        method: "POST",
        credentials: "include", // ← Cookie を送る
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ tenant: TENANT, ...(body||{}) }),
      });
      if (r.status === 401) throw new Error("unauthorized");
      if (!r.ok) throw new Error(`http_${r.status}`);
      return await r.json();
    }

    async function tryLoad() {
      try {
        const data = await api("listLeads");
        render(data.items ? (Array.isArray(data.items)? data.items : [data.items]) : []);
      } catch(e) {
        if(String(e.message).includes("unauthorized")) {
          dlg.showModal();
        } else {
          showToast("読み込み失敗");
        }
      }
    }

    function render(items){
      grid.innerHTML = "";
      if(!items?.length){ $("#empty").style.display="block"; return; }
      $("#empty").style.display="none";
      for(const it of items){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" data-id="${it.id}"></td>
          <td>${escapeHtml(it.name||"")}</td>
          <td>${escapeHtml(it.email||"")}</td>
          <td>${escapeHtml(it.channel||"")}</td>
          <td>${escapeHtml(it.note||"")}</td>
          <td class="muted">${escapeHtml((it.createdAt||"").replace("T"," ").replace("Z",""))}</td>
          <td class="muted">${it.id}</td>
        `;
        grid.appendChild(tr);
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // --- events
    $("#btn-refresh").onclick = tryLoad;

    $("#btn-export").onclick = async () => {
      try {
        const r = await fetch(`/api?action=exportLeads`, {
          method: "POST", credentials: "include",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ tenant: TENANT })
        });
        if(r.status===401) throw new Error("unauthorized");
        const blob = await r.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "leads.csv";
        a.click();
        URL.revokeObjectURL(a.href);
      } catch(e){ if(String(e).includes("unauthorized")) dlg.showModal(); }
    };

    $("#btn-del").onclick = async () => {
      const ids = [...document.querySelectorAll('tbody input[type="checkbox"]:checked')].map(x=>x.dataset.id);
      if(!ids.length) return showToast("選択がありません");
      if(!confirm(`${ids.length} 件削除します。よろしいですか？`)) return;
      for(const id of ids){
        await api("deleteLead", { id });
      }
      showToast("削除しました");
      await tryLoad();
    };

    $("#btn-logout").onclick = async()=>{ await fetch("/admin/logout", { credentials:"include" }); showToast("ログアウトしました"); setTimeout(()=>location.reload(), 500); };

    $("#check-all").onchange = (e)=>{
      const c = e.currentTarget.checked;
      document.querySelectorAll('tbody input[type="checkbox"]').forEach(x=>x.checked=c);
    };

    $("#do-login").onclick = async (ev) => {
      ev.preventDefault();
      const key = (document.querySelector("#admin-key") as HTMLInputElement).value.trim();
      if(!key) return;
      const r = await fetch("/admin/login", { method:"POST", credentials:"include", headers: { "x-admin-key": key } });
      if(!r.ok){ showToast("認証失敗"); return; }
      dlg.close();
      showToast("ログインしました");
      await tryLoad();
    };

    tryLoad();
  </script>
</body>
</html>
