<!-- /admin.html -->
<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin – Leads</title>
<style>
  body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;margin:24px;color:#111}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,button,select{padding:10px 12px;border:1px solid #00000022;border-radius:10px;font-size:14px}
  button{background:#111;color:#fff;cursor:pointer}
  table{border-collapse:collapse;width:100%;margin-top:16px}
  th,td{border-bottom:1px solid #0000001a;padding:8px 6px;text-align:left;font-size:14px}
  .muted{color:#666}
  .ok{color:#19c37d}.err{color:#ef4444}
</style>

<h1>Admin / Leads</h1>

<div class="row">
  <input id="adminKey" type="password" placeholder="ADMIN_KEY を入力してログイン" style="min-width:320px" />
  <button id="loginBtn">ログイン</button>
  <button id="logoutBtn">ログアウト</button>
  <span id="state" class="muted">未確認</span>
</div>

<div class="row" style="margin-top:12px">
  <button id="reloadBtn">再読込</button>
  <button id="csvBtn">CSVエクスポート</button>
  <span class="muted">tenant:</span>
  <input id="tenant" value="salon-booking-saas" style="width:240px" />
</div>

<table id="tbl" style="display:none">
  <thead><tr><th>id</th><th>name</th><th>email</th><th>toolId</th><th>createdAt</th><th></th></tr></thead>
  <tbody></tbody>
</table>

<script>
const $ = (s)=>document.querySelector(s);
const state = $("#state");
const TBL = $("#tbl");
const TB = TBL.querySelector("tbody");

async function jsonPost(url, body, headers = {}) {
  const r = await fetch(url, {
    method: "POST",
    headers: { "content-type": "application/json", ...headers },
    body: JSON.stringify(body || {}),
    credentials: "include",
  });
  const t = await r.text();
  try { return { status: r.status, data: JSON.parse(t) }; }
  catch { return { status: r.status, data: t }; }
}

async function check() {
  const tenant = $("#tenant").value.trim();
  const { status, data } = await jsonPost("/api?action=listLeads", { tenant });
  if (status === 200 && data?.ok) {
    state.textContent = "ログイン済み";
    state.className = "ok";
    render(Array.isArray(data.items) ? data.items : (data.items ? [data.items] : []));
  } else {
    state.textContent = "未ログイン";
    state.className = "err";
    render([]);
  }
}

function render(items) {
  TB.innerHTML = "";
  if (!items || items.length === 0) {
    TBL.style.display = "none";
    return;
  }
  TBL.style.display = "";
  for (const it of items) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="muted">${it.id || ""}</td>
      <td>${it.name || ""}</td>
      <td>${it.email || ""}</td>
      <td class="muted">${it.toolId || ""}</td>
      <td class="muted">${it.createdAt || ""}</td>
      <td><button data-id="${it.id}">削除</button></td>`;
    TB.appendChild(tr);
  }
}

$("#loginBtn").onclick = async () => {
  const key = $("#adminKey").value;
  if (!key) return alert("ADMIN_KEY を入力してね");
  const r = await fetch("/admin/login", {
    method: "POST",
    headers: { "content-type": "application/json", "x-admin-key": key },
    credentials: "include",
    body: JSON.stringify({ key }),
  });
  if (r.ok) { $("#adminKey").value = ""; await check(); }
  else { state.textContent = "ログイン失敗"; state.className = "err"; }
};

$("#logoutBtn").onclick = async () => {
  await fetch("/admin/logout", { credentials: "include" });
  await check();
};

$("#reloadBtn").onclick = check;

$("#csvBtn").onclick = async () => {
  const tenant = $("#tenant").value.trim();
  const r = await fetch("/api?action=exportLeads", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ tenant }),
    credentials: "include",
  });
  if (!r.ok) return alert("エクスポート失敗");
  const blob = await r.blob();
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), { href: url, download: "leads.csv" });
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

TB.addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-id]");
  if (!btn) return;
  const id = btn.getAttribute("data-id");
  const tenant = $("#tenant").value.trim();
  if (!confirm(`削除しますか？\n${id}`)) return;
  const r = await jsonPost("/api?action=deleteLead", { tenant, id });
  if (r.status === 200 && r.data?.ok) check();
  else alert("削除に失敗しました");
});

check();
</script>
