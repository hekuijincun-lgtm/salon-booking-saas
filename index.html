<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salon Booking â€“ å…ˆè¡Œç™»éŒ²</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; padding:24px; }
    .wrap { max-width: 640px; margin: 0 auto; }
    h1 { margin: 0 0 8px; }
    label { display:block; margin:12px 0 4px; font-weight:600; }
    input, textarea, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; }
    button { margin-top:16px; padding:12px 16px; border:0; border-radius:10px; font-weight:700; cursor:pointer; }
    .primary { background:#111; color:#fff; }
    .muted { color:#666; font-size:13px; margin-top:8px; }
    .ok { color:#0a7c2f; font-weight:700; }
    .err { color:#c40000; font-weight:700; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    small.code { background:#f6f6f6; border:1px solid #eee; padding:2px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
  <noscript><meta http-equiv="refresh" content="0;url=about:blank"><style>body{display:none}</style></noscript>
</head>
<body>
  <div class="wrap">
    <h1>Salon Booking / å…ˆè¡Œç™»éŒ²</h1>
    <p class="muted">é€ä¿¡ã™ã‚‹ã¨ãƒªãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã€<code>/admin</code> ã§è¦‹ãˆã‚‹ã‚ˆã€‚</p>

    <!-- å¿…é ˆã® hiddenï¼ˆå®Ÿãƒ†ãƒŠãƒ³ãƒˆIDã¨ãƒ„ãƒ¼ãƒ«IDã«æ›´æ–°æ¸ˆã¿ï¼‰ -->
    <input type="hidden" id="tenant" value="t_2f3072fe13e82051" />
    <input type="hidden" id="toolId" value="tool_salon_booking_v1" />

    <label for="name">ãŠåå‰</label>
    <input id="name" autocomplete="name" placeholder="å±±ç”° å¤ªéƒ" required />

    <label for="email">ãƒ¡ãƒ¼ãƒ«</label>
    <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com" required />

    <label for="channel">é€£çµ¡ãƒãƒ£ãƒãƒ«</label>
    <select id="channel">
      <option value="email">Email</option>
      <option value="line">LINE</option>
      <option value="twitter">X(Twitter) DM</option>
    </select>

    <label for="notes">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="notes" rows="4" placeholder="å°å…¥æ¤œè¨ã®èƒŒæ™¯ãªã©"></textarea>

    <div class="row">
      <button class="primary" id="send">é€ä¿¡ã™ã‚‹</button>
      <small id="ping" class="muted"></small>
    </div>

    <div id="status" class="muted" aria-live="polite"></div>
  </div>

  <script>
    // --- è¦ç´ å‚ç…§ ---
    const btn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const pingEl = document.getElementById('ping');

    // --- èµ·å‹•æ™‚: APIç–é€šãƒã‚§ãƒƒã‚¯ (/health) & å‰å›å…¥åŠ›ã®å¾©å…ƒ ---
    (async () => {
      try {
        const r = await fetch('/health', { method: 'GET' });
        const j = await r.json().catch(()=> ({}));
        if (r.ok && j && j.ok) {
          pingEl.textContent = `API Online (${j.service} ${j.version}) âœ…`;
        } else {
          pingEl.textContent = 'APIç–é€šã«å¤±æ•—â€¦ âŒ';
        }
      } catch {
        pingEl.textContent = 'APIç–é€šã«å¤±æ•—â€¦ âŒ';
      }
      // å‰å›å…¥åŠ›ã‚’å¾©å…ƒï¼ˆè»½ã„UXæ”¹å–„ï¼‰
      try {
        const last = JSON.parse(localStorage.getItem('lead:last') || '{}');
        if (last.name)  document.getElementById('name').value  = last.name;
        if (last.email) document.getElementById('email').value = last.email;
      } catch {}
    })();

    // --- UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ï¼ˆã‚ã‚Œã°ä¿å­˜ï¼‰ ---
    function readUTM() {
      const p = new URLSearchParams(location.search);
      const keys = ['utm_source','utm_medium','utm_campaign','utm_term','utm_content'];
      const o = {};
      for (const k of keys) { const v = p.get(k); if (v) o[k] = v; }
      if (document.referrer) o.referrer = document.referrer;
      return o;
    }

    // --- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ---
    function validate({ name, email }) {
      if (!name || name.length < 2) return 'ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ã­';
      const okEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email || '');
      if (!okEmail) return 'ãƒ¡ãƒ¼ãƒ«ã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆ';
      return null;
    }

    // --- é€ä¿¡ãƒãƒ³ãƒ‰ãƒ© ---
    btn.addEventListener('click', async () => {
      btn.disabled = true;
      statusEl.textContent = 'é€ä¿¡ä¸­â€¦';

      const tenant = (document.getElementById('tenant')?.value || '').trim();
      const toolId = (document.getElementById('toolId')?.value || '').trim();
      const name   = document.getElementById('name').value.trim();
      const email  = document.getElementById('email').value.trim();
      const memo   = document.getElementById('notes').value.trim();
      const channel= document.getElementById('channel').value;

      const err = validate({ name, email });
      if (err) {
        statusEl.innerHTML = '<span class="err">' + err + '</span>';
        btn.disabled = false;
        return;
      }
      if (!tenant.startsWith('t_')) {
        statusEl.innerHTML = '<span class="err">tenantãŒç™ºè¡ŒID(t_...)ã«ãªã£ã¦ãªã„ã‚ˆ</span>';
        btn.disabled = false;
        return;
      }

      // ä¾¿åˆ©: å…¥åŠ›ã®ä¸€éƒ¨ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
      try { localStorage.setItem('lead:last', JSON.stringify({ name, email })); } catch {}

      // è¿½åŠ ãƒ¡ã‚¿ï¼ˆUTMã‚„UAï¼‰ã‚‚payloadã¸
      const meta = readUTM();
      const body = {
        action: 'saveLead',
        tenant, // Workerå´ã§ã‚‚ãƒ˜ãƒƒãƒ€ã‹ã‚‰æ‹¾ã†ãŒã€å¿µã®ãŸã‚bodyã«ã‚‚æ®‹ã™
        payload: {
          toolId, name, email, memo, channel,
          meta, ua: navigator.userAgent, ts: new Date().toISOString()
        }
      };

      try {
        const res = await fetch('/api', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-tenant-id': tenant   // â† ã“ã‚ŒãŒè¶…é‡è¦ï¼ˆlicense/tenantåˆ¤å®šï¼‰
            // x-api-key ã¯ Pages ã® _worker.js å´ã§ã‚µãƒ¼ãƒæ³¨å…¥ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã§æ™’ã•ãªã„ï¼‰
          },
          body: JSON.stringify(body),
        });

        // JSONã§èª­ã‚ãªã‹ã£ãŸæ™‚ã‚‚å®‰å…¨ã«æ‰±ã†
        let json = {};
        try { json = await res.json(); } catch {}

        if (res.ok && json.ok !== false) {
          statusEl.innerHTML = '<span class="ok">ä¿å­˜å®Œäº†ï¼</span> å–¶æ¥­ã‚ªãƒ¼ãƒˆãƒ¡ã®æ­¯è»Šã€å›ã‚Šå‡ºã—ãŸã‚ˆğŸ‰';
          // è»½ããƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ï¼ˆåå‰/ãƒ¡ãƒ¼ãƒ«ã¯æ®‹ã™ï¼‰
          document.getElementById('notes').value = '';
        } else {
          const msg = json.error || ('HTTP ' + res.status);
          statusEl.innerHTML = '<span class="err">ä¿å­˜å¤±æ•—â€¦</span> ' + msg;
          // ãƒ©ã‚¤ã‚»ãƒ³ã‚¹/ãƒ†ãƒŠãƒ³ãƒˆç³»ã®å®šç•ªã‚¨ãƒ©ãƒ¼ã‚’ãƒ’ãƒ³ãƒˆè¡¨ç¤º
          if (msg.includes('license_inactive')) {
            statusEl.innerHTML += 'ï¼ˆ/admin ã§ç™ºè¡Œã—ãŸ <span class="code">tenant_id</span> ã‚’ hidden ã«å…¥ã‚Œã¦ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼‰';
          }
          if (msg.includes('tenant_missing')) {
            statusEl.innerHTML += 'ï¼ˆ<span class="code">x-tenant-id</span> ãƒ˜ãƒƒãƒ€ãŒå±Šã„ã¦ãªã„å¯èƒ½æ€§ï¼‰';
          }
        }
      } catch (e) {
        statusEl.innerHTML = '<span class="err">é€ä¿¡ã‚¨ãƒ©ãƒ¼</span> ' + (e?.message || e);
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
