<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salon Booking – 先行登録</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{--bg:#fafafa;--card:#fff;--ink:#111;--sub:#666;--bd:#eee;--ok:#16a34a;--ng:#ef4444}
    @media (prefers-color-scheme: dark){
      :root{--bg:#0b0b0c;--card:#141416;--ink:#f5f5f6;--sub:#a1a1aa;--bd:#232327}
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif}
    .wrap{max-width:900px;margin:36px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 8px}
    p.lead{margin:0 0 20px;color:var(--sub)}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
    label{display:block;margin:14px 0 6px;font-weight:600}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--bd);background:transparent;color:inherit}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .row .shrink{flex:0 0 auto}
    button{padding:12px 18px;border-radius:12px;border:1px solid var(--bd);cursor:pointer;font-weight:600}
    .btn{background:var(--ink);color:var(--card)}
    .ghost{background:transparent;color:var(--ink)}
    .status{display:inline-flex;align-items:center;gap:8px;color:var(--sub);font-size:14px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.ng{background:var(--ng)} .dot.wait{background:#f59e0b}
    .msg{margin-top:14px;font-weight:600}
    .msg.ok{color:var(--ok)} .msg.ng{color:var(--ng)} .msg.dim{color:var(--sub);font-weight:400}
    .hint{font-size:12px;color:var(--sub)}
    .hr{height:1px;background:var(--bd);margin:18px 0}
    .right{margin-left:auto}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--bd);border-radius:999px;font-size:12px;color:var(--sub)}
  </style>
  <!-- Turnstile（使う時だけ sitekey を入れる。空なら自動スキップ） -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <div class="wrap">
    <h1>Salon Booking / 先行登録</h1>
    <p class="lead">送信するとリードが保存され、<code>/admin</code> で見られます。</p>

    <div class="card">
      <form id="lead-form" onsubmit="return false">
        <label for="name">お名前</label>
        <input id="name" name="name" placeholder="山田 太郎" autocomplete="name" required />

        <label for="email">メール</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" autocomplete="email" required />

        <label for="channel">連絡チャネル</label>
        <select id="channel" name="channel">
          <option>Email</option>
          <option>LINE</option>
          <option>Instagram</option>
          <option>Phone</option>
          <option>Other</option>
        </select>

        <label for="note">メモ（任意）</label>
        <textarea id="note" name="note" placeholder="導入検討の背景など"></textarea>

        <!-- Turnstile（サイトキーがあれば data-sitekey を設定） -->
        <div id="ts-wrap" style="margin-top:12px;display:none">
          <div class="cf-turnstile" data-sitekey="" data-theme="light"></div>
          <div class="hint">※ セキュリティチェック</div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <button id="send" class="btn shrink">送信する</button>
          <button id="clear" class="ghost shrink" type="button">クリア</button>
          <span class="right status"><span id="dot" class="dot wait"></span><span id="stat-text">API接続を確認中…</span></span>
        </div>
        <div id="msg" class="msg dim">※ 迷惑メール対策のため同じメールは上書き保存（重複登録されません）。</div>
      </form>
    </div>

    <p class="hint" style="margin-top:12px">
      <span class="pill">tenant: <b id="tenant-pill">salon-booking-saas</b></span>
    </p>
  </div>

  <script>
    // ===== 設定 =====
    const APP = {
      tenant: "salon-booking-saas",
      endpoint: "/api/add-lead", // ← API Functions（トークン不要の公開エンドポイント）
      // Turnstile サイトキー（使う時だけ設定）例: "0x0000000000000000000000000000000AA"
      turnstileSiteKey: ""
    };

    // ===== DOM =====
    const $ = (s)=>document.querySelector(s);
    const form = $("#lead-form");
    const dot  = $("#dot");
    const stat = $("#stat-text");
    const msg  = $("#msg");
    const tsWrap = $("#ts-wrap");

    // ===== 初期化 =====
    (async function init(){
      $("#tenant-pill").textContent = APP.tenant;
      // Turnstile: sitekey があれば表示
      if (APP.turnstileSiteKey) {
        tsWrap.style.display = "block";
        const el = tsWrap.querySelector(".cf-turnstile");
        el.setAttribute("data-sitekey", APP.turnstileSiteKey);
      }
      // API ヘルス表示
      try {
        const r = await fetch("/health", { cache: "no-store" });
        if (r.ok) { dot.className = "dot ok"; stat.textContent = "API Online"; }
        else      { dot.className = "dot ng"; stat.textContent = "API応答なし"; }
      } catch {
        dot.className = "dot ng"; stat.textContent = "API接続エラー";
      }
    })();

    // ===== 送信 =====
    $("#send").addEventListener("click", submitLead);
    $("#clear").addEventListener("click", () => { form.reset(); setMsg("クリアしました。", "dim"); });

    async function submitLead(){
      const name = $("#name").value.trim();
      const email = $("#email").value.trim().toLowerCase();
      const channel = $("#channel").value.trim();
      const note = $("#note").value.trim();

      if (!name || !email) return setMsg("お名前とメールは必須です。", "ng");
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return setMsg("メール形式が正しくありません。", "ng");

      setMsg("送信中…", "dim");
      const headers = { "content-type": "application/json" };

      // Turnstile トークン（あればヘッダに付与）
      const tsInput = document.querySelector('input[name="cf-turnstile-response"]');
      if (tsInput && tsInput.value) headers["cf-turnstile-response"] = tsInput.value;

      try{
        const res = await fetch(APP.endpoint, {
          method: "POST",
          headers,
          body: JSON.stringify({ tenant: APP.tenant, name, email, channel, note }),
        });

        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.ok) {
          const err = data?.error || `http_${res.status}`;
          if (err === "rate_limited") return setMsg("連投が早すぎます。60秒ほど空けて再送してください。", "ng");
          if (err === "missing_turnstile_token") return setMsg("セキュリティチェックを完了してください。", "ng");
          return setMsg(`保存失敗… ${err}`, "ng");
        }

        setMsg("保存しました。ありがとうございます！", "ok");
        try { window.turnstile && window.turnstile.reset && window.turnstile.reset(); } catch {}
      }catch(e){
        setMsg("API接続に失敗しました。ネットワークを確認してください。", "ng");
      }
    }

    function setMsg(text, cls){
      msg.className = `msg ${cls||"dim"}`;
      msg.textContent = text;
    }
  </script>
</body>
</html>
